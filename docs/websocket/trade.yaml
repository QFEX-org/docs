asyncapi: 3.0.0
info:
  title: QFEX Multiplexed WebSocket API
  version: 1.0.0
  description: |-
    Single WebSocket gateway for all QFEX realâ€‘time streams.  
    Clients publish subscription and order commands here,  
    and receive all updates over the same endpoint.
defaultContentType: application/json
servers:
  production:
    host: trade.qfex.com
    protocol: wss
    description: Production WebSocket gateway

channels:
  qfex:
    address: /
    description: Single channel for order commands, positions, balances
    # parameters:
    #   apiKey:
    #     $ref: "#/components/parameters/apiKey"
    messages:
      authenticate:
        $ref: "#/components/messages/AuthenticateCommand"
      subscribePositions:
        $ref: "#/components/messages/SubscribePositionsCommand"
      subscribeBalance:
        $ref: "#/components/messages/SubscribeBalanceCommand"
      getLeverage:
        $ref: "#/components/messages/GetLeverageCommand"
      setLeverage:
        $ref: "#/components/messages/SetLeverageCommand"
      getAvailableLeverage:
        $ref: "#/components/messages/GetAvailableLeverageCommand"
      addOrder:
        $ref: "#/components/messages/AddOrderCommand"
      cancelOrder:
        $ref: "#/components/messages/CancelOrderCommand"
      modifyOrder:
        $ref: "#/components/messages/ModifyOrderCommand"
      cancelAllOrders:
        $ref: "#/components/messages/CancelAllOrdersCommand"
      balanceUpdate:
        $ref: "#/components/messages/BalanceUpdate"
      positionUpdate:
        $ref: "#/components/messages/PositionUpdate"

operations:
  authenticate:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Authenticate with the WebSocket gateway
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/authenticate"
  subscribePositionsStream:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Subscribe to a data stream
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/subscribePositions"

  subscribeBalanceStream:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Subscribe to a data stream
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/subscribeBalance"

  getLeverageLevels:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Get user leverage levels
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/getLeverage"

  setLeverageLevels:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Set user leverage levels
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/setLeverage"

  getAvailableLeverageLevels:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Get available leverage levels
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/getAvailableLeverage"

  placeOrder:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Place a new order
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/addOrder"

  cancelOrder:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Cancel an existing order
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/cancelOrder"

  modifyOrder:
    action: receive
    channel:
      $ref: "#/channels/qfex"
    summary: Modify an existing order
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/modifyOrder"

  receiveUpdates:
    action: send
    channel:
      $ref: "#/channels/qfex"
    summary: Receive all update messages and events
    # traits:
    #   - $ref: "#/components/operationTraits/websocket"
    messages:
      - $ref: "#/channels/qfex/messages/balanceUpdate"
      - $ref: "#/channels/qfex/messages/positionUpdate"

components:
  parameters:
    apiKey:
      description: Your QFEx API key

  securitySchemes:
    ApiKeyQuery:
      type: httpApiKey
      name: api_key # ?api_key=YOUR_KEY
      in: query
      description: "Provide your API key as a query parameter (?api_key=...)."

  messageTraits:
    commonHeaders:
      headers:
        type: object
        properties:
          x-qfex-client:
            type: string
            description: Client identifier

  operationTraits:
    websocket:
      bindings:
        ws: {}

  messages:
    AuthenticateCommand:
      name: authenticate
      title: Authenticate
      summary: Authenticate to the WebSocket gateway. Required before any other commands.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/AuthenticateCommand"
    SubscribePositionsCommand:
      name: subscribe_positions
      title: Subscribe to Positions
      summary: Subscribe to user positions. Receive 1s pulsed updates on current positions.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/SubscribePositionsCommand"
    SubscribeBalanceCommand:
      name: subscribe_balance
      title: Subscribe to Balance
      summary: Subscribe to user balance. Receive 1s pulsed updates on current balance.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/SubscribeBalanceCommand"

    SetLeverageCommand:
      name: set_leverage
      title: Set Leverage
      summary: Set leverage level for a symbol
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/SetLeverageCommand"
    GetLeverageCommand:
      name: get_leverage
      title: Get Leverage
      summary: Get current leverage levels per symbol
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/GetLeverageCommand"
    GetAvailableLeverageCommand:
      name: get_available_leverage
      title: Get Available Leverage
      summary: Get available leverage levels per symbol
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/GetAvailableLeverageCommand"

    AddOrderCommand:
      name: add_order
      title: Add Order
      summary: Add order.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/AddOrderCommand"

    CancelOrderCommand:
      name: cancel_order
      title: Cancel Order
      summary: Cancel order.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/CancelOrderCommand"

    ModifyOrderCommand:
      name: modify_order
      title: Modify Order
      summary: Modify order.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/ModifyOrderCommand"

    CancelAllOrdersCommand:
      name: cancel_all_orders
      title: Cancel All Orders
      summary: Cancel all orders.
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/CancelAllOrdersCommand"

    BalanceUpdate:
      name: balance_update
      title: Balance Update
      summary: User balance updates
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/BalanceUpdate"

    PositionUpdate:
      name: position_update
      title: Position Update
      summary: User position updates
      contentType: application/json
      traits:
        - $ref: "#/components/messageTraits/commonHeaders"
      payload:
        $ref: "#/components/schemas/PositionUpdate"

  schemas:
    MessageEnvelope:
      type: object
      properties:
        type:
          type: string
        connection_id:
          type: string
        message_id:
          type: integer
        channel:
          type: string
        id:
          type: string
      required:
        - type
        - connection_id
        - message_id

    SubscribePositionsCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - unsubscribe
            - subscribe
        params:
          type: object
          properties:
            channels:
              type: array
              items:
                type: string
                enum:
                  - positions
              description: positions
      required:
        - type
        - params

    SubscribeBalanceCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - unsubscribe
            - subscribe
        params:
          type: object
          properties:
            channels:
              type: array
              items:
                type: string
                enum:
                  - balances
              description: balances
      required:
        - type
        - params

    SetLeverageCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - set_user_leverage
        params:
          type: object
          properties:
            symbol:
              type: string
            leverage:
              type: number
      required:
        - type
        - params
    GetLeverageCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - get_user_leverage
        params:
          type: object
          properties:
            limit:
              type: number
            offset:
              type: number
      required:
        - type
        - params
    GetAvailableLeverageCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - get_available_leverage_levels
        params:
          type: object
          properties:
            limit:
              type: number
            offset:
              type: number
      required:
        - type
        - params

    AuthenticateCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - auth
        params:
          type: object
          properties:
            api_key:
              type: string
          required:
            - api_key
      required:
        - type
        - params

    AddOrderCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - add_order
        params:
          type: object
          properties:
            symbol:
              type: string
            side:
              type: string
              enum:
                - BUY
                - SELL
            order_type:
              type: string
              enum:
                - LIMIT
                - MARKET
                - ALO
            order_time_in_force:
              type: string
              enum:
                - GTC
                - IOC
                - FOK
            quantity:
              type: number
            price:
              type: number
              description: This is only required for LIMIT or ALO orders
            take_profit:
              type: number
            stop_loss:
              type: number
          required:
            - symbol
            - side
            - order_type
            - order_time_in_force
            - quantity
      required:
        - type
        - params
    CancelOrderCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - cancel_order
        params:
          type: object
          properties:
            symbol:
              type: string
            order_id:
              type: string
            cancel_order_id_type:
              type: string
              enum:
                - order_id
                - client_order_id
          required:
            - symbol
            - order_id
            - cancel_order_id_type
      required:
        - type
        - params
    ModifyOrderCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - modify_order
        params:
          type: object
          properties:
            symbol:
              type: string
            order_id:
              type: string
            price:
              type: number
            quantity:
              type: number
            take_profit:
              type: number
            stop_loss:
              type: number
          required:
            - symbol
            - order_id
      required:
        - type
        - params
    CancelAllOrdersCommand:
      type: object
      properties:
        type:
          type: string
          enum:
            - cancel_all_orders
        params:
          type: object
          properties: {}
      required:
        - type
        - params

    BalanceUpdate:
      examples:
        - type: subscribed
          connection_id: "ee987ddf-822c-4356-b0d1-012314859b00"
          message_id: 1
          id: "3ab267fd-7c83-49c6-b42e-65bb94682b41"
          channel: v4_balances
          contents:
            - id: "2cb208e3-6e54-48c4-82e9-641e64bf185d"
              user_id: "0f5208e3-6e54-48c4-82e9-641e64bf185d"
              deposit: 1000
              realised_pnl: -898.65735
              unrealised_pnl: 0
              order_margin: 0
              position_margin: 0
              net_funding: -1.5354636
              available_balance: 99.80721
      allOf:
        - $ref: "#/components/schemas/MessageEnvelope"
        - type: object
          properties:
            contents:
              type: array
              items:
                $ref: "#/components/schemas/BalancePayload"

    PositionUpdate:
      examples:
        - type: subscribed
          connection_id: "ee987ddf-822c-4356-b0d1-012314859b00"
          message_id: 1
          id: "3ab267fd-7c83-49c6-b42e-65bb94682b41"
          channel: v4_positions
          contents:
            - id: "PLTR-USD"
              symbol: "PLTR-USD"
              user_id: "0f5208e3-6e54-48c4-82e9-641e64bf185d"
              position: 0
              margin_alloc: 0
              realised_pnl: 1.327875
              unrealised_pnl: 0
              net_funding: 0.00000482
              open_orders: 1
              open_quantity: 10
              leverage: 20
              initial_margin: 0
              maintenance_margin: 0
              average_price: 0
              timestamp: "2025-05-09T03:47:20.505934+00:00"
      allOf:
        - $ref: "#/components/schemas/MessageEnvelope"
        - type: object
          properties:
            contents:
              type: array
              items:
                $ref: "#/components/schemas/PositionPayload"

    BboPayload:
      type: object
      properties:
        symbol:
          type: string
        bidPrice:
          type: string
        bidSize:
          type: string
        askPrice:
          type: string
        askSize:
          type: string

    OrderBookPayload:
      type: object
      properties:
        bids:
          type: array
          items:
            type: array
            items:
              type: string
        asks:
          type: array
          items:
            type: array
            items:
              type: string

    TradePayload:
      type: object
      properties:
        id:
          type: string
        price:
          type: string
        size:
          type: string
        side:
          type: string
        createdAt:
          type: string
          format: date-time

    CandlePayload:
      type: object
      properties:
        startedAt:
          type: string
        ticker:
          type: string
        resolution:
          type: string
        open:
          type: string
        high:
          type: string
        low:
          type: string
        close:
          type: string
        usdVolume:
          type: string

    BalancePayload:
      type: object
      properties:
        deposit:
          type: number
        realised_pnl:
          type: number
        unrealised_pnl:
          type: number
        order_margin:
          type: number
        position_margin:
          type: number
        available_balance:
          type: number

    PositionPayload:
      type: object
      properties:
        symbol:
          type: string
        position:
          type: number
        average_price:
          type: number

    PnlEntryPayload:
      type: object
      properties:
        user_id:
          type: string
        available_balance:
          type: number
        realised_pnl:
          type: number
